+++
title = "架设kvm虚拟化服务器 "
date = "2014-05-29T17:07:00+08:00"
tags = ["ubuntu","server","kvm"]

+++

软硬件环境：
*   ubuntu-14.04-server-amd64.iso
*   ibm x3550 m3

工具：
*   ultra-iso
*   u盘（用来制作启动盘）
*   putty
*   TightVNC

---
### 制作启动盘
    1.  通过ultra-iso打开ubuntu-14.04-server-amd64.iso
    2.  点击启动 -> 写入硬盘映像，点击格式化 *fat32 快速格式化*  
    3.  写入并等待完成
---
###安装ubuntu过程
    注意以下三点
        1.  语言有中文但是因为默认没有配置字体，故还是选en_US的比较好
        2.  配置network默认是dhcp，dhcp取得ip后，back至上一步手动分配个静态ip。服务器还是静态比较靠谱
        3.  安装服务的时候，openssh、samba勾上，便于远程管理，ssh虽然能传文件，但感觉不是那么方便哈哈
---
###kvm
1.  要安装必要的软件包，从终端中输入：
    
        sudo apt-get install qemu-kvm libvirt-bin
        
    在安装了libvirt-bin后，用于管理虚拟机的用户需要被添加到libvirtd组。这样做会赋予这个用户   进入到高级网络选项的权限。

        sudo adduser $USER libvirtd

2.  安装virt-install

        sudo apt-get install virtinst
        
3.  安装guest
        
        sudo virt-install -n web_devel -r 256 \
        --disk path=/var/lib/libvirt/images/web_devel.img,bus=virtio,size=4 -c \
        ubuntu-14.04-server-i386.iso --network network=default,model=virtio \
        --graphics vnc,listen=0.0.0.0 --noautoconsole -v
    
4.  网络配置
    
    如果按第3步中_network=default_，guest可以访问外网，但不能访问host和其他guest。如果用作服务器的话，显然不行。
    故如下配置bridge:
    安装bridge相关工具
            
            sudo apt-get install bridge-utils
    编辑/etc/network/interfaces

            auto lo
            iface lo inet loopback

            auto eth0
            iface eth0 inet manual

            auto br0
            iface br0 inet static
                    address 192.168.0.10
                    network 192.168.0.0
                    netmask 255.255.255.0
                    broadcast 192.168.0.255
                    gateway 192.168.0.1
                    bridge_ports eth0
                    bridge_stp off
                    bridge_fd 0
                    bridge_maxwait 0
or DHCP:

            auto lo
            iface lo inet loopback

            auto eth0
            iface eth0 inet manual

            auto br0
            iface br0 inet dhcp
                    bridge_ports eth0
                    bridge_stp off
                    bridge_fd 0
                    bridge_maxwait 0
重启网络服务：
    
            sudo /etc/init.d/networking restart
or
            
            sudo ifup br0
通过virsh创建bridge虚拟网络:
            
            virsh
            net-create bridge.xml
xml内容：
                      
            <network>
            <name>host-bridge</name>
            <forward mode="bridge"/>
            <bridge name="br0"/>
            </network>
编辑guest配置，将网络由nat模式改为bridge 
            
            edit <guest domain>
将
                
            <interface type='network'>
            <mac address='00:11:22:33:44:55'/>
            <source network='default'/>
            </interface>
改为：
            
            <interface type='bridge'>
            <mac address='00:11:22:33:44:55'/>
            <source bridge='br0'/>
            </interface>
关闭虚拟机，并重启libvirtd服务:
        
            sudo /etc/init.d/libvirtd restart
启动虚拟机，检测下是桥接是否运行正常，下图vnet0是guest虚拟网卡，br0是桥接网卡，eth1为物理网卡：

            # brctl show
            bridge name     bridge id               STP enabled     interfaces
            br0             8000.e41f13b416f6       no              eth1
                                                                    vnet0
5.  oem激活

    请参看[此篇](http://blog.lofyer.org/slic-for-qemu-kvm/)，这不作详解了