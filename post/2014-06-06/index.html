<!DOCTYPE html>
<html lang="">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">


<base href="https://netcookies.github.io/b/">
<title>


     配置 Samba4 作为 AD域控制器 

</title>
<link rel="canonical" href="https://netcookies.github.io/b/post/2014-06-06/">


<script type="text/javascript">
    var baseURL = 'https:\/\/netcookies.github.io\/b\/';
    var host = baseURL.substring(0, baseURL.length - 1).replace(/\//g, '');
    if ((host === window.location.host) && (window.location.protocol !== 'https:')) {
        window.location.protocol = 'https:';
    }
</script>





<link rel="stylesheet" href="/css/reset.css">
<link rel="stylesheet" href="/css/pygments.css">
<link rel="stylesheet" href="/css/main.css">




<link rel="shortcut icon"

    href="/img/favicon.ico"

>






</head>


<body lang="">

<section class="header"> 
    <div class="container">
        <div class="content">
            
            <a href="/"><div class="name"></div></a>
            <nav>
                <ul>
                    <a href="/blog/"><li>Blog</li></a>
                    <a href="/about/"><li>About</li></a>
                    <a href="/code/"><li>Code</li></a>
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">

        
        
        

        

        

        

        

        
            <a href="https://netcookies.github.io/b/index.xml">
                <i class="icon ion-social-rss larger"></i>
            </a>
        
        </div>
    </div>
</section>

<section class="main">
    <div class="container">
        <div class="content">
            <p>Enviroment :
    * archlinux
    * samba 4.1.8</p>

<ol>
<li><p>安装需要的包</p>

<pre><code>pacman -S dnsutils krb5 ntp openldap samba
</code></pre></li>

<li><p>配置fstab使域可以兼容，unix, osx系统的加入</p>

<pre><code>/dev/...          /srv/samba/demo          ext4          user_xattr,acl,barrier=1          1 1
</code></pre></li>

<li><p>使用samba-tool 生成Samba 4的配置文件</p>

<pre><code>samba-tool domain provision --use-rfc2307 --interactive --use-xattrs=yes
</code></pre>

<p>交互式的依次输入，域名、主机名、管理员密码， 其他默认即可</p></li>
</ol>

<hr />

<ol>
<li><p>配置服务</p>

<p>使用下面的命令生成ntpd服务</p>

<pre><code>```bash
mv /etc/ntp.conf{,.default}
cat &gt; /etc/ntp.conf &lt;&lt; &quot;EOF&quot;
# Begin /etc/ntp.conf

# Associate to the public NTP pool servers
server 0.pool.ntp.org
server 1.pool.ntp.org
server 2.pool.ntp.org

# Location of drift file
driftfile /var/lib/ntp/ntp.drift

# Location of the log file
logfile /var/log/ntp

# Location of the update directory
ntpsigndsocket /var/lib/samba/ntp_signd/

# Restrictions
restrict default kod nomodify notrap nopeer mssntp
restrict 127.0.0.1
restrict 0.pool.ntp.org mask 255.255.255.255 nomodify notrap nopeer noquery
restrict 1.pool.ntp.org mask 255.255.255.255 nomodify notrap nopeer noquery
restrict 2.pool.ntp.org mask 255.255.255.255 nomodify notrap nopeer noquery

# End /etc/ntp.conf
EOF
install -d /var/lib/samba/ntp_signd
chown root:ntp /var/lib/samba/ntp_signd
chmod 0750 /var/lib/samba/ntp_signd
systemctl enable ntpd.service
systemctl start ntpd
```
</code></pre>

<p>使用本机ip做为dns</p>

<pre><code>cat &gt;&gt; /etc/resolvconf.conf &lt;&lt; &quot;EOF&quot;
search_domains=internal.domain.tld
name_servers=xxx.xxx.xxx.xxx 
EOF
resolvconf -u
</code></pre>

<p>krb密码策略</p>

<pre><code>mv /etc/krb5.conf{,.default}
cp /var/lib/samba/private/krb5.conf /etc
</code></pre>

<p>启动Samba服务</p>

<pre><code>rm -rf /var/lib/samba/ntp_signd
systemctl enable samba.service
systemctl start samba
</code></pre>

<p>修复ntp可能产生的权限问题</p>

<pre><code>chgrp ntp /var/lib/samba/ntp_signd
systemctl restart ntpd
</code></pre>

<p>启用LDB模块</p>

<pre><code>echo &quot;export LDB_MODULES_PATH=\&quot;\${LDB_MODULES_PATH}:/usr/lib/samba/ldb\&quot;&quot; &gt; /etc/profile.d/sambaldb.sh
chmod 0755 /etc/profile.d/sambaldb.sh
</code></pre></li>
</ol>

<hr />

<p>5.测试配置是否成功
    dns</p>

<pre><code>    host -t SRV _ldap._tcp.internal.domain.com.
    host -t SRV _kerberos._udp.internal.domain.com.
    host -t A server.internal.domain.com.
返回如果如下表示成功：

    _ldap._tcp.internal.domain.com has SRV record 0 100 389 server.internal.domain.com.
    _kerberos._udp.internal.domain.com has SRV record 0 100 88      server.internal.domain.com.
    server.internal.domain.com has address xxx.xxx.xxx.xxx
NT登录验证

    smbclient //localhost/netlogon -U Administrator -c 'ls'
Kerberos

    kinit administrator@INTERNAL.DOMAIN.COM //注意此处大写
回显如下：

    Warning: Your password will expire in 41 days on Wed 08 Jan 2014 11:59:11 PM CST
确认是否得到验证的ticket:

    klist
回显如下：

    Ticket cache: FILE:/tmp/krb5cc_0
    Default principal: administrator@INTERNAL.DOMAIN.COM

    Valid starting       Expires              Service principal
    11/28/2013 00:22:17  11/28/2013 10:22:17        krbtgt/INTERNAL.DOMAIN.COM@INTERNAL.DOMAIN.COM
        renew until 11/29/2013 00:22:14
</code></pre>

<p>最后使用smbclient测试ticket有效情况：</p>

<pre><code>    smbclient //server/netlogon -k -c 'ls'
</code></pre>

<hr />

<p>_quoted from <a href="https://wiki.archlinux.org/index.php/Samba_4_Active_Directory_Domain_Controller">Samba 4 Active Directory Domain Controller</a>_</p>

        </div>
    </div>
</section>






</body>
</html>

